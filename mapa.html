<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Proteccion Animal - Mapa</title>

  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="icon" type="image/x-icon" href="favicon.ico">

  <style>
    /* Evita que algo ‚Äúapriete‚Äù el mapa */
    .map-wrap {
      max-width: 1100px;
      margin: 0 auto;
      padding: 18px;
      width: 100%;
    }

    .map-card {
      overflow: hidden;
      border-radius: 18px;
    }

    /* ‚úÖ MAPA: grande en PC (como ‚Äúantes‚Äù) */
    #map {
      width: 100%;
      height: 78vh;
      min-height: 520px;
    }

    /* Tablet */
    @media (max-width: 1024px) {
      #map {
        height: 70vh;
        min-height: 460px;
      }
    }

    /* M√≥vil */
    @media (max-width: 640px) {
      #map {
        height: 60vh;
        min-height: 360px;
      }
    }

    /* ‚úÖ Fallback por si tu styles.css no incluye modal */
    .modal {
      position: fixed;
      inset: 0;
      display: none;
      z-index: 260000;
    }

    .modal.open {
      display: block;
    }

    .modal__backdrop {
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, 0.35);
      backdrop-filter: blur(4px);
    }

    .modal__card {
      position: relative;
      max-width: 560px;
      width: calc(100% - 24px);
      margin: 70px auto 24px;
      border-radius: 18px;
      background: rgba(255, 255, 255, 0.92);
      border: 1px solid rgba(17, 119, 204, 0.18);
      box-shadow: 0 24px 70px rgba(0, 0, 0, 0.18);
      overflow: hidden;
    }

    .modal__head {
      padding: 14px 16px;
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 10px;
      border-bottom: 1px solid rgba(17, 119, 204, 0.10);
      background: rgba(234, 246, 255, 0.65);
    }

    .modal__title {
      font-weight: 1000;
      font-size: 16px;
    }

    .modal__subtitle {
      font-weight: 800;
      font-size: 12px;
      color: #4a6173;
      margin-top: 2px;
    }

    .modal__close {
      cursor: pointer;
      border: none;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 12px;
      padding: 8px 10px;
      font-weight: 900;
    }

    .modal__body {
      padding: 14px 16px 16px;
    }
  </style>
</head>

<body>

  <header class="topbar">
    <div class="topbar__inner">
      <a class="brand" href="index.html">
        <span class="brand__dot"></span>
        <span class="brand__text">Proteccion Animal</span>
      </a>

      <nav class="nav">
        <a class="nav__link" href="index.html">Principal</a>
        <a class="nav__link nav__link--active" href="mapa.html">Mapa</a>
      </nav>

      <!-- ‚úÖ USER con dropdown (igual que en index) -->
      <div class="user user--menu" id="userMenuWrap">
        <a class="user__btn" href="login.html" id="userBtn" aria-label="Cuenta">
          <span class="user__text" id="userLabel">Login</span>
        </a>

        <div class="user-dropdown" id="userDropdown" aria-label="Men√∫ usuario">
          <a class="user-dropdown__item" href="configurar.html" id="configUserBtn">‚öôÔ∏è Configurar usuario</a>
          <button class="user-dropdown__item user-dropdown__danger" type="button" id="logoutTopBtn">
            üö™ Cerrar sesi√≥n
          </button>
        </div>
      </div>
    </div>
  </header>

  <main class="map-wrap">
    <div class="map-card">
      <div class="map-header">
        <div class="map-header__left">
          <h2 class="map-title">Mapa - La Nuc√≠a</h2>
          <p class="map-subtitle">Doble click en el mapa para a√±adir voluntario o punto de alimentaci√≥n.</p>

          <!-- Botones arriba -->
          <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
            <button class="btn btn--primary" id="shareBtn" type="button">Compartir mapa</button>
            <button class="btn btn--ghost" id="searchVolunteerBtn" type="button">Voluntarios</button>

            <!-- ‚úÖ buscador de puntos -->
            <button class="btn btn--ghost" id="searchFoodBtn" type="button">Puntos</button>
          </div>
        </div>

        <div class="map-actions">
          <button class="btn btn--danger" id="logoutBtn" type="button">Cerrar sesi√≥n</button>
        </div>
      </div>

      <div id="map"></div>
    </div>
  </main>

  <!-- FOOTER -->
  <footer class="footer">
    <p>¬© <span id="year"></span> Extension de bello horizonte - PROTECCION ANIMAL</p>
  </footer>

  <!-- ‚úÖ input oculto para foto desde archivos -->
  <input id="photoInput" type="file" accept="image/*" style="display:none;" />

  <!-- ‚úÖ MODAL para elegir foto (gesto de usuario real => abre el selector SI o SI) -->
  <div id="photoModal" class="modal" aria-hidden="true">
    <div class="modal__backdrop" id="photoModalBg"></div>

    <div class="modal__card" role="dialog" aria-modal="true" aria-label="A√±adir foto">
      <div class="modal__head">
        <div>
          <div class="modal__title">A√±adir foto</div>
          <div class="modal__subtitle">Opcional. Elige una imagen desde tu dispositivo.</div>
        </div>
        <button class="modal__close" id="photoModalClose" type="button">‚úñ</button>
      </div>

      <div class="modal__body">
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn btn--primary" id="pickPhotoBtn" type="button">üì∑ Elegir archivo</button>
          <button class="btn btn--ghost" id="skipPhotoBtn" type="button">Omitir</button>
        </div>

        <p class="note" style="margin-top:10px;">
          * Si cancelas el selector, se guardar√° sin foto.
        </p>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    document.getElementById("year").textContent = new Date().getFullYear();

    // =========================
    // SESI√ìN LOCAL
    // =========================
    function getCurrentUserEmail() {
      return localStorage.getItem("currentUserEmail");
    }

    function requireLogin() {
      const email = getCurrentUserEmail();
      if (!email) {
        window.location.href = "login.html";
        return null;
      }
      return email;
    }

    const currentEmail = requireLogin();
    if (!currentEmail) throw new Error("No session");

    // =============================
    // ‚úÖ USER TOPBAR (dropdown)
    // =============================
    (function () {
      const userLabel = document.getElementById("userLabel");
      const userBtn = document.getElementById("userBtn");
      const logoutTopBtn = document.getElementById("logoutTopBtn");
      const wrap = document.getElementById("userMenuWrap");
      const dropdown = document.getElementById("userDropdown");

      if (!userLabel || !userBtn || !logoutTopBtn || !wrap || !dropdown) return;

      const profileKey = `profile:${currentEmail}`;
      const profile = JSON.parse(localStorage.getItem(profileKey)) || {};

      const displayName = (profile.displayName && profile.displayName.trim() !== "")
        ? profile.displayName.trim()
        : currentEmail;

      userLabel.textContent = displayName;
      userBtn.href = "#";

      if (profile.photoUrl && profile.photoUrl.trim() !== "") {
        if (!document.getElementById("userAvatarImg")) {
          const img = document.createElement("img");
          img.id = "userAvatarImg";
          img.src = profile.photoUrl.trim();
          img.alt = "Avatar";
          img.className = "user__avatar";
          userBtn.insertBefore(img, userBtn.firstChild);
        }
      }

      userBtn.addEventListener("click", (e) => {
        e.preventDefault();
        wrap.classList.toggle("open");
      });

      logoutTopBtn.addEventListener("click", () => {
        localStorage.removeItem("currentUserEmail");
        window.location.href = "login.html";
      });

      document.addEventListener("click", (e) => {
        if (!wrap.contains(e.target)) wrap.classList.remove("open");
      });
    })();

    // =============================
    // KEYS (por usuario)
    // =============================
    const STORAGE_KEY_MARKERS = `markerLocations:${currentEmail}`;
    const SHARES_KEY = `shares:${currentEmail}`;

    // =============================
    // MAPA (LA NUC√çA)
    // =============================
    const map = L.map('map').setView([38.6140, -0.1266], 14);
    setTimeout(() => map.invalidateSize(), 200);

    const normal = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    });

    const satellite = L.tileLayer(
      'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
      { attribution: 'Tiles ¬© Esri' }
    );

    normal.addTo(map);
    L.control.layers({ "Mapa normal": normal, "Sat√©lite": satellite }).addTo(map);

    map.doubleClickZoom.disable();

    // =============================
    // ICONOS
    // =============================
    function makePinIcon(color) {
      const svg = `
        <svg xmlns="http://www.w3.org/2000/svg" width="34" height="46" viewBox="0 0 24 24">
          <path fill="${color}" d="M12 2c-3.86 0-7 3.14-7 7 0 5.25 7 13 7 13s7-7.75 7-13c0-3.86-3.14-7-7-7z"/>
          <circle cx="12" cy="9" r="2.6" fill="#ffffff"/>
        </svg>
      `.trim();

      const url = "data:image/svg+xml;charset=UTF-8," + encodeURIComponent(svg);

      return L.icon({
        iconUrl: url,
        iconSize: [34, 46],
        iconAnchor: [17, 46],
        popupAnchor: [0, -40]
      });
    }

    const volunteerIcon = makePinIcon("#e53935");
    const foodIcon = makePinIcon("#1e8e3e");

    // =============================
    // helpers voluntario -> punto
    // =============================
    function fpIdFromLatLng(lat, lng) {
      const a = Number(lat).toFixed(6);
      const b = Number(lng).toFixed(6);
      return `fp:${a}:${b}`;
    }

    function getFoodPointNameById(foodPointId) {
      if (!foodPointId) return "";
      const fp = markerLocations.find(m => m.type === "Punto de alimentaci√≥n" && m.fpId === foodPointId);
      return fp ? (fp.name || "Punto de alimentaci√≥n") : "";
    }

    // =============================
    // ‚úÖ FOTO desde archivos (base64)
    // =============================
    const photoInput = document.getElementById("photoInput");

    function pickImageFile(callback) {
      if (!photoInput) return callback(null);

      photoInput.value = "";

      const onChange = () => {
        const file = photoInput.files && photoInput.files[0];
        photoInput.removeEventListener("change", onChange);

        if (!file) return callback(null);

        const reader = new FileReader();
        reader.onload = () => callback(String(reader.result || ""));
        reader.onerror = () => callback(null);
        reader.readAsDataURL(file);
      };

      photoInput.addEventListener("change", onChange, { once: true });
      photoInput.click();
    }

    // =============================
    // ‚úÖ Modal de foto (para que SI se abra el selector)
    // =============================
    const photoModal = document.getElementById("photoModal");
    const photoModalBg = document.getElementById("photoModalBg");
    const photoModalClose = document.getElementById("photoModalClose");
    const pickPhotoBtn = document.getElementById("pickPhotoBtn");
    const skipPhotoBtn = document.getElementById("skipPhotoBtn");

    let __photoCb = null;

    function openPhotoModal(cb) {
      __photoCb = cb;
      if (!photoModal) return cb(null);

      photoModal.classList.add("open");
      photoModal.setAttribute("aria-hidden", "false");
    }

    function closePhotoModal() {
      if (!photoModal) return;
      photoModal.classList.remove("open");
      photoModal.setAttribute("aria-hidden", "true");
    }

    function finishPhotoModal(result) {
      const cb = __photoCb;
      __photoCb = null;
      closePhotoModal();
      if (cb) cb(result);
    }

    if (photoModalBg) photoModalBg.addEventListener("click", () => finishPhotoModal(null));
    if (photoModalClose) photoModalClose.addEventListener("click", () => finishPhotoModal(null));

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && photoModal && photoModal.classList.contains("open")) {
        finishPhotoModal(null);
      }
    });

    if (skipPhotoBtn) {
      skipPhotoBtn.addEventListener("click", () => finishPhotoModal(null));
    }

    if (pickPhotoBtn) {
      pickPhotoBtn.addEventListener("click", () => {
        pickImageFile((dataUrl) => {
          finishPhotoModal(dataUrl || null);
        });
      });
    }

    // =============================
    // DATOS LOCALES
    // =============================
    let markerLocations = JSON.parse(localStorage.getItem(STORAGE_KEY_MARKERS)) || [];
    const markersByKey = new Map();

    (function migrateMarkers() {
      let changed = false;

      markerLocations.forEach(m => {
        if (m.type === "Punto de alimentaci√≥n" && !m.fpId) {
          m.fpId = fpIdFromLatLng(m.lat, m.lng);
          changed = true;
        }
        if (m.type === "Voluntario" && typeof m.foodPointId === "undefined") {
          m.foodPointId = "";
          changed = true;
        }
      });

      if (changed) {
        localStorage.setItem(STORAGE_KEY_MARKERS, JSON.stringify(markerLocations));
      }
    })();

    markerLocations.forEach(loc => {
      createMarker(loc.lat, loc.lng, loc.type, loc.name, loc.description, loc.photo);
    });

    // =============================
    // DOBLE CLICK -> A√ëADIR (‚úÖ modal foto)
    // =============================
    map.on('dblclick', function (e) {
      const { lat, lng } = e.latlng;

      const option = prompt(
        "¬øQu√© quieres a√±adir?\n\n" +
        "1) Voluntario üî¥\n" +
        "2) Punto de alimentaci√≥n üü¢\n\n" +
        "Escribe 1 o 2:"
      );

      let type = null;
      if (option === "1") type = "Voluntario";
      if (option === "2") type = "Punto de alimentaci√≥n";
      if (!type) return;

      const name = prompt("Nombre:");
      const description = prompt("Descripci√≥n:");

      if (!name || !description) return;

      const saveMarker = (photoDataUrl) => {
        const obj = { lat, lng, type, name, description, photo: photoDataUrl || "" };

        if (type === "Punto de alimentaci√≥n") obj.fpId = fpIdFromLatLng(lat, lng);
        if (type === "Voluntario") obj.foodPointId = "";

        markerLocations.push(obj);
        localStorage.setItem(STORAGE_KEY_MARKERS, JSON.stringify(markerLocations));
        createMarker(lat, lng, type, name, description, obj.photo);
      };

      // ‚úÖ En vez de confirm(), abrimos modal (mucho m√°s fiable)
      openPhotoModal((dataUrlOrNull) => {
        saveMarker(dataUrlOrNull || "");
      });
    });

    // =============================
    // CREAR MARCADOR + BORRAR (tu sistema)
    // =============================
    function createMarker(lat, lng, type, name, description, photo) {
      const icon = (type === "Punto de alimentaci√≥n") ? foodIcon : volunteerIcon;

      let belongsHtml = "";
      if (type === "Voluntario") {
        const obj = markerLocations.find(m =>
          m.type === "Voluntario" && Number(m.lat) === Number(lat) && Number(m.lng) === Number(lng)
        );

        const fpName = obj ? getFoodPointNameById(obj.foodPointId) : "";

        if (fpName) {
          belongsHtml = `
            <div style="margin-top:8px; padding:8px; border-radius:12px; background: rgba(30,142,62,0.10); border: 1px solid rgba(30,142,62,0.22);">
              <b>üü¢ Pertenece a:</b> ${escapeHtml(fpName)}
            </div>
          `;
        } else {
          belongsHtml = `
            <div class="note" style="margin-top:8px;">
              (No asignado a ning√∫n punto de alimentaci√≥n)
            </div>
          `;
        }
      }

      const typeColor = (type === "Punto de alimentaci√≥n") ? "#1e8e3e" : "#e53935";

      const marker = L.marker([lat, lng], { icon }).addTo(map)
        .bindPopup(`
          <b>${escapeHtml(name)}</b><br>
          <span style="font-weight:900;color:${typeColor};">
            ${escapeHtml(type)}
          </span><br>
          ${escapeHtml(description)}<br>
          ${photo ? `<img src="${escapeAttr(photo)}" style="width:100px;height:100px;object-fit:cover;border-radius:10px;margin-top:8px;">` : ""}
          ${belongsHtml}
          <div style="margin-top:10px;">
            <button type="button" class="popup-btn danger"
              data-action="delete"
              data-lat="${lat}"
              data-lng="${lng}">
              Eliminar
            </button>
          </div>
        `)
        .bindTooltip(name, { direction: 'top' });

      const key = buildKey(type, name, lat, lng);
      markersByKey.set(key, marker);
    }

    map.on("popupopen", function (e) {
      const root = e.popup.getElement();
      if (!root) return;

      root.querySelectorAll("button[data-action='delete']").forEach(btn => {
        if (btn.dataset.bound === "1") return;
        btn.dataset.bound = "1";

        btn.addEventListener("click", (ev) => {
          ev.preventDefault();
          ev.stopPropagation();

          const lat = Number(btn.dataset.lat);
          const lng = Number(btn.dataset.lng);

          const ok = confirm("¬øSeguro que quieres eliminar este marcador?");
          if (!ok) return;

          deleteMarker(lat, lng);
          map.closePopup();
        });
      });
    });

    function deleteMarker(lat, lng) {
      map.eachLayer(function (layer) {
        if (layer instanceof L.Marker &&
          layer.getLatLng().lat === lat &&
          layer.getLatLng().lng === lng) {
          map.removeLayer(layer);
        }
      });

      markerLocations = markerLocations.filter(loc => !(loc.lat === lat && loc.lng === lng));
      localStorage.setItem(STORAGE_KEY_MARKERS, JSON.stringify(markerLocations));

      markersByKey.clear();
      markerLocations.forEach(loc => createMarker(loc.lat, loc.lng, loc.type, loc.name, loc.description, loc.photo));
    }

    // =============================
    // BUSCAR VOLUNTARIO
    // =============================
    document.getElementById("searchVolunteerBtn").addEventListener("click", () => {
      const query = prompt("¬øQu√© voluntario quieres buscar? (escribe nombre o parte del nombre)");
      if (!query) return;

      const q = query.trim().toLowerCase();
      const volunteers = markerLocations.filter(m =>
        m.type === "Voluntario" && (m.name || "").toLowerCase().includes(q)
      );

      if (volunteers.length === 0) {
        alert("No se encontr√≥ ning√∫n voluntario con ese nombre.");
        return;
      }

      if (volunteers.length === 1) {
        focusVolunteer(volunteers[0]);
        return;
      }

      const menu = volunteers.map((v, i) => `${i + 1}) ${v.name}`).join("\n");
      const choice = prompt(`He encontrado varios. Elige uno:\n\n${menu}\n\nEscribe el n√∫mero:`);

      const idx = Number(choice) - 1;
      if (Number.isNaN(idx) || idx < 0 || idx >= volunteers.length) {
        alert("Selecci√≥n no v√°lida.");
        return;
      }

      focusVolunteer(volunteers[idx]);
    });

    function focusVolunteer(v) {
      const key = buildKey(v.type, v.name, v.lat, v.lng);
      const marker = markersByKey.get(key);

      map.setView([v.lat, v.lng], 17, { animate: true });
      if (marker) marker.openPopup();
    }

    // =============================
    // BUSCAR PUNTO DE ALIMENTACI√ìN
    // =============================
    document.getElementById("searchFoodBtn").addEventListener("click", () => {
      const query = prompt("¬øQu√© punto de alimentaci√≥n quieres buscar? (nombre o parte del nombre)");
      if (!query) return;

      const q = query.trim().toLowerCase();
      const points = markerLocations.filter(m =>
        m.type === "Punto de alimentaci√≥n" && (m.name || "").toLowerCase().includes(q)
      );

      if (points.length === 0) {
        alert("No se encontr√≥ ning√∫n punto de alimentaci√≥n con ese nombre.");
        return;
      }

      if (points.length === 1) {
        focusFoodPoint(points[0]);
        return;
      }

      const menu = points.map((p, i) => `${i + 1}) ${p.name}`).join("\n");
      const choice = prompt(`He encontrado varios puntos. Elige uno:\n\n${menu}\n\nEscribe el n√∫mero:`);

      const idx = Number(choice) - 1;
      if (Number.isNaN(idx) || idx < 0 || idx >= points.length) {
        alert("Selecci√≥n no v√°lida.");
        return;
      }

      focusFoodPoint(points[idx]);
    });

    function focusFoodPoint(p) {
      const key = buildKey(p.type, p.name, p.lat, p.lng);
      const marker = markersByKey.get(key);

      map.setView([p.lat, p.lng], 17, { animate: true });
      if (marker) marker.openPopup();
    }

    function buildKey(type, name, lat, lng) {
      return `${type}:${String(name).toLowerCase()}:${lat}:${lng}`;
    }

    // =============================
    // COMPARTIR (LOCAL)
    // =============================
    document.getElementById("shareBtn").addEventListener("click", () => {
      const email = prompt("Correo de la persona con la que quieres compartir el mapa:");
      if (!email) return;

      const clean = email.trim().toLowerCase();
      if (!clean.includes("@")) {
        alert("Correo no v√°lido.");
        return;
      }

      const list = JSON.parse(localStorage.getItem(SHARES_KEY)) || [];
      if (list.includes(clean)) {
        alert("Ya est√° compartido con ese correo.");
        return;
      }

      list.push(clean);
      localStorage.setItem(SHARES_KEY, JSON.stringify(list));
      alert("Compartido (modo local) con: " + clean);
    });

    // =============================
    // LOGOUT
    // =============================
    document.getElementById("logoutBtn").addEventListener("click", () => {
      localStorage.removeItem("currentUserEmail");
      window.location.href = "login.html";
    });

    // Utils escape
    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, (m) => ({
        "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#039;"
      }[m]));
    }

    function escapeAttr(str) {
      return escapeHtml(str).replace(/`/g, "&#096;");
    }
  </script>

</body>

</html>
