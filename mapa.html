<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Proteccion Animal - Mapa</title>

  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="icon" type="image/x-icon" href="favicon.ico">

  <style>
    .map-wrap { max-width: 1100px; margin: 0 auto; padding: 18px; width: 100%; }
    .map-card { overflow: hidden; border-radius: 18px; }
    #map { width: 100%; height: 78vh; min-height: 520px; }
    @media (max-width: 1024px) { #map { height: 70vh; min-height: 460px; } }
    @media (max-width: 640px) { #map { height: 60vh; min-height: 360px; } }

    .modal { position: fixed; inset: 0; display: none; z-index: 260000; }
    .modal.open { display: block; }
    .modal__backdrop { position: absolute; inset: 0; background: rgba(0,0,0,0.35); backdrop-filter: blur(4px); }
    .modal__card {
      position: relative; max-width: 560px; width: calc(100% - 24px); margin: 70px auto 24px;
      border-radius: 18px; background: rgba(255,255,255,0.92);
      border: 1px solid rgba(17,119,204,0.18);
      box-shadow: 0 24px 70px rgba(0,0,0,0.18);
      overflow: hidden;
    }
    .modal__head {
      padding: 14px 16px; display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
      border-bottom: 1px solid rgba(17,119,204,0.10);
      background: rgba(234,246,255,0.65);
    }
    .modal__title { font-weight: 1000; font-size: 16px; }
    .modal__subtitle { font-weight: 800; font-size: 12px; color: #4a6173; margin-top: 2px; }
    .modal__close { cursor:pointer; border:none; background: rgba(255,255,255,0.9); border-radius: 12px; padding: 8px 10px; font-weight: 900; }
    .modal__body { padding: 14px 16px 16px; }

    /* ‚úÖ Para que NO se vea el mapa ni el contenido hasta validar sesi√≥n */
    body[data-ready="0"] main,
    body[data-ready="0"] footer { display: none; }
  </style>
</head>

<body data-ready="0">

  <header class="topbar">
    <div class="topbar__inner">
      <a class="brand" href="index.html">
        <span class="brand__dot"></span>
        <span class="brand__text">Proteccion Animal</span>
      </a>

      <nav class="nav">
        <a class="nav__link" href="index.html">Principal</a>
        <a class="nav__link nav__link--active" href="mapa.html">Mapa</a>
      </nav>

      <!-- ‚úÖ Usuario: si no hay sesi√≥n -> link a login
           si hay sesi√≥n -> bot√≥n que abre dropdown (NO navega) -->
      <div class="user user--menu" id="userMenuWrap">
        <a class="user__btn" href="login.html" id="userBtn" aria-label="Cuenta">
          <span class="user__text" id="userLabel">Login</span>
        </a>

        <div class="user-dropdown" id="userDropdown" aria-label="Men√∫ usuario">
          <a class="user-dropdown__item" href="configurar.html" id="configUserBtn">‚öôÔ∏è Configurar usuario</a>
          <button class="user-dropdown__item user-dropdown__danger" type="button" id="logoutTopBtn">üö™ Cerrar sesi√≥n</button>
        </div>
      </div>
    </div>
  </header>

  <main class="map-wrap">
    <div class="map-card">
      <div class="map-header">
        <div class="map-header__left">
          <h2 class="map-title">Mapa - La Nuc√≠a</h2>
          <p class="map-subtitle">Doble click en el mapa para a√±adir voluntario o punto de alimentaci√≥n.</p>

          <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
            <button class="btn btn--primary" id="shareBtn" type="button">Compartir mapa</button>
            <button class="btn btn--ghost" id="searchVolunteerBtn" type="button">Voluntarios</button>
            <button class="btn btn--ghost" id="searchFoodBtn" type="button">Puntos</button>
          </div>
        </div>

        <div class="map-actions">
          <button class="btn btn--danger" id="logoutBtn" type="button">Cerrar sesi√≥n</button>
        </div>
      </div>

      <div id="map"></div>
    </div>
  </main>

  <footer class="footer">
    <p>¬© <span id="year"></span> Extension de bello horizonte - PROTECCION ANIMAL</p>
  </footer>

  <input id="photoInput" type="file" accept="image/*" style="display:none;" />

  <div id="photoModal" class="modal" aria-hidden="true">
    <div class="modal__backdrop" id="photoModalBg"></div>
    <div class="modal__card" role="dialog" aria-modal="true" aria-label="A√±adir foto">
      <div class="modal__head">
        <div>
          <div class="modal__title">A√±adir foto</div>
          <div class="modal__subtitle">Opcional. Elige una imagen desde tu dispositivo.</div>
        </div>
        <button class="modal__close" id="photoModalClose" type="button">‚úñ</button>
      </div>
      <div class="modal__body">
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn btn--primary" id="pickPhotoBtn" type="button">üì∑ Elegir archivo</button>
          <button class="btn btn--ghost" id="skipPhotoBtn" type="button">Omitir</button>
        </div>
        <p class="note" style="margin-top:10px;">* Si cancelas el selector, se guardar√° sin foto.</p>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    // ====== SUPABASE CONFIG ======
    const SUPABASE_URL = "https://vkyusosabullpvudxafy.supabase.co";
    const SUPABASE_KEY = "sb_publishable_8JbsqfmoH05omWj1p2jPXg_EwZDntlT";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const BUCKET = "marker-photos";

    document.getElementById("year").textContent = new Date().getFullYear();

    // ====== helpers ======
    function fpIdFromLatLng(lat, lng) {
      return `fp:${Number(lat).toFixed(6)}:${Number(lng).toFixed(6)}`;
    }
    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, (m) => ({
        "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#039;"
      }[m]));
    }
    function escapeAttr(str) { return escapeHtml(str).replace(/`/g, "&#096;"); }

    function uuid() {
      if (window.crypto && crypto.randomUUID) return crypto.randomUUID();
      // fallback simple (evita que reviente en navegadores raros)
      return "id-" + Date.now() + "-" + Math.random().toString(16).slice(2);
    }

    // ====== session required ======
    let currentUser = null;

    async function requireLoginSupabase() {
      const { data } = await supabase.auth.getSession();
      const session = data?.session;
      if (!session) {
        window.location.replace("login.html");
        return null;
      }
      return session.user;
    }

    // ====== UI header dropdown ======
    function setupHeader(user) {
      const userLabel = document.getElementById("userLabel");
      const userBtn = document.getElementById("userBtn");
      const logoutTopBtn = document.getElementById("logoutTopBtn");
      const wrap = document.getElementById("userMenuWrap");

      const displayName =
        (user?.user_metadata && user.user_metadata.display_name && String(user.user_metadata.display_name).trim() !== "")
          ? String(user.user_metadata.display_name).trim()
          : (user?.email || "Cuenta");

      userLabel.textContent = displayName;

      // ‚úÖ IMPORTANTE:
      // - si hay sesi√≥n: NO navega, solo abre dropdown
      userBtn.href = "#";
      userBtn.addEventListener("click", (e) => {
        e.preventDefault();
        wrap.classList.toggle("open");
      });

      // cerrar al clicar fuera
      document.addEventListener("click", (e) => {
        if (!wrap.contains(e.target)) wrap.classList.remove("open");
      });

      // cerrar sesi√≥n
      logoutTopBtn.addEventListener("click", async () => {
        await supabase.auth.signOut();
        window.location.replace("login.html");
      });
    }

    // ====== Map setup (se crea SOLO cuando hay sesi√≥n) ======
    let map = null;
    let markerLocations = [];      // rows DB
    const markersById = new Map(); // id -> leaflet marker

    function initMap() {
      map = L.map("map").setView([38.6140, -0.1266], 14);

      const normal = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "&copy; OpenStreetMap contributors"
      });

      const satellite = L.tileLayer(
        "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
        { attribution: "Tiles ¬© Esri" }
      );

      normal.addTo(map);
      L.control.layers({ "Mapa normal": normal, "Sat√©lite": satellite }).addTo(map);
      map.doubleClickZoom.disable();

      // ‚úÖ Asegura que se vea bien el mapa
      setTimeout(() => map.invalidateSize(), 250);
    }

    function makePinIcon(color) {
      const svg = `
        <svg xmlns="http://www.w3.org/2000/svg" width="34" height="46" viewBox="0 0 24 24">
          <path fill="${color}" d="M12 2c-3.86 0-7 3.14-7 7 0 5.25 7 13 7 13s7-7.75 7-13c0-3.86-3.14-7-7-7z"/>
          <circle cx="12" cy="9" r="2.6" fill="#ffffff"/>
        </svg>
      `.trim();
      return L.icon({
        iconUrl: "data:image/svg+xml;charset=UTF-8," + encodeURIComponent(svg),
        iconSize: [34, 46],
        iconAnchor: [17, 46],
        popupAnchor: [0, -40]
      });
    }

    const volunteerIcon = makePinIcon("#e53935");
    const foodIcon = makePinIcon("#1e8e3e");

    function getPublicUrl(path) {
      if (!path) return "";
      const { data } = supabase.storage.from(BUCKET).getPublicUrl(path);
      return data?.publicUrl || "";
    }

    function getFoodPointNameByFpId(fpId) {
      const fp = markerLocations.find(m => m.type === "Punto de alimentaci√≥n" && m.fp_id === fpId);
      return fp ? (fp.name || "Punto de alimentaci√≥n") : "";
    }

    function clearAllMarkers() {
      markersById.forEach(m => map.removeLayer(m));
      markersById.clear();
    }

    function createMarkerFromRow(row) {
      const icon = (row.type === "Punto de alimentaci√≥n") ? foodIcon : volunteerIcon;

      let belongsHtml = "";
      if (row.type === "Voluntario") {
        const fpName = getFoodPointNameByFpId(row.food_point_id || "");
        belongsHtml = fpName
          ? `<div style="margin-top:8px; padding:8px; border-radius:12px; background: rgba(30,142,62,0.10); border: 1px solid rgba(30,142,62,0.22);">
              <b>üü¢ Pertenece a:</b> ${escapeHtml(fpName)}
            </div>`
          : `<div class="note" style="margin-top:8px;">(No asignado a ning√∫n punto de alimentaci√≥n)</div>`;
      }

      const typeColor = (row.type === "Punto de alimentaci√≥n") ? "#1e8e3e" : "#e53935";
      const photoUrl = row.photo_path ? getPublicUrl(row.photo_path) : "";

      const marker = L.marker([row.lat, row.lng], { icon }).addTo(map)
        .bindPopup(`
          <b>${escapeHtml(row.name)}</b><br>
          <span style="font-weight:900;color:${typeColor};">${escapeHtml(row.type)}</span><br>
          ${escapeHtml(row.description)}<br>
          ${photoUrl ? `<img src="${escapeAttr(photoUrl)}" style="width:100px;height:100px;object-fit:cover;border-radius:10px;margin-top:8px;">` : ""}
          ${belongsHtml}
          <div style="margin-top:10px;">
            <button type="button" class="popup-btn danger"
              data-action="delete"
              data-id="${row.id}">
              Eliminar
            </button>
          </div>
        `)
        .bindTooltip(row.name, { direction: "top" });

      markersById.set(row.id, marker);
    }

    async function loadMarkers() {
      const { data, error } = await supabase
        .from("markers")
        .select("*")
        .order("created_at", { ascending: true });

      if (error) {
        alert("Error cargando marcadores: " + error.message);
        return;
      }

      markerLocations = data || [];
      clearAllMarkers();
      markerLocations.forEach(createMarkerFromRow);
    }

    async function deleteMarkerById(id) {
      const row = markerLocations.find(m => m.id === id);
      if (!row) return;

      const { error } = await supabase.from("markers").delete().eq("id", id);
      if (error) return alert("Error borrando: " + error.message);

      if (row.photo_path) {
        await supabase.storage.from(BUCKET).remove([row.photo_path]);
      }

      await loadMarkers();
    }

    // bind delete buttons
    function bindPopupDeleteHandlers() {
      map.on("popupopen", function (e) {
        const root = e.popup.getElement();
        if (!root) return;

        root.querySelectorAll("button[data-action='delete']").forEach(btn => {
          if (btn.dataset.bound === "1") return;
          btn.dataset.bound = "1";

          btn.addEventListener("click", async (ev) => {
            ev.preventDefault();
            ev.stopPropagation();

            const id = btn.dataset.id; // id puede ser uuid o number
            const ok = confirm("¬øSeguro que quieres eliminar este marcador?");
            if (!ok) return;

            await deleteMarkerById(id);
            map.closePopup();
          });
        });
      });
    }

    // ====== photo modal (file upload) ======
    const photoInput = document.getElementById("photoInput");
    const photoModal = document.getElementById("photoModal");
    const photoModalBg = document.getElementById("photoModalBg");
    const photoModalClose = document.getElementById("photoModalClose");
    const pickPhotoBtn = document.getElementById("pickPhotoBtn");
    const skipPhotoBtn = document.getElementById("skipPhotoBtn");

    let __photoCb = null;

    function openPhotoModal(cb) {
      __photoCb = cb;
      photoModal.classList.add("open");
      photoModal.setAttribute("aria-hidden", "false");
    }
    function closePhotoModal() {
      photoModal.classList.remove("open");
      photoModal.setAttribute("aria-hidden", "true");
    }
    function finishPhotoModal(fileOrNull) {
      const cb = __photoCb;
      __photoCb = null;
      closePhotoModal();
      if (cb) cb(fileOrNull);
    }

    photoModalBg.addEventListener("click", () => finishPhotoModal(null));
    photoModalClose.addEventListener("click", () => finishPhotoModal(null));
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && photoModal.classList.contains("open")) finishPhotoModal(null);
    });
    skipPhotoBtn.addEventListener("click", () => finishPhotoModal(null));

    function pickImageFile(cb) {
      photoInput.value = "";
      const onChange = () => {
        const file = photoInput.files && photoInput.files[0];
        photoInput.removeEventListener("change", onChange);
        cb(file || null);
      };
      photoInput.addEventListener("change", onChange, { once: true });
      photoInput.click();
    }

    pickPhotoBtn.addEventListener("click", () => {
      pickImageFile((file) => finishPhotoModal(file));
    });

    async function uploadPhotoIfAny(file) {
      if (!file) return "";

      const ext = (file.name.split(".").pop() || "jpg").toLowerCase().replace(/[^a-z0-9]/g, "") || "jpg";
      const path = `${currentUser.id}/${uuid()}.${ext}`;

      const { error } = await supabase.storage
        .from(BUCKET)
        .upload(path, file, { upsert: false, contentType: file.type });

      if (error) {
        alert("Error subiendo foto: " + error.message);
        return "";
      }
      return path;
    }

    // ====== add marker ======
    function bindDblClickAddMarker() {
      map.on("dblclick", function (e) {
        const { lat, lng } = e.latlng;

        const option = prompt(
          "¬øQu√© quieres a√±adir?\n\n" +
          "1) Voluntario üî¥\n" +
          "2) Punto de alimentaci√≥n üü¢\n\n" +
          "Escribe 1 o 2:"
        );

        let type = null;
        if (option === "1") type = "Voluntario";
        if (option === "2") type = "Punto de alimentaci√≥n";
        if (!type) return;

        const name = prompt("Nombre:");
        const description = prompt("Descripci√≥n:");
        if (!name || !description) return;

        openPhotoModal(async (fileOrNull) => {
          const photo_path = await uploadPhotoIfAny(fileOrNull);

          const row = {
            owner_id: currentUser.id,
            lat, lng, type,
            name, description,
            photo_path: photo_path || null,
            fp_id: type === "Punto de alimentaci√≥n" ? fpIdFromLatLng(lat, lng) : null,
            food_point_id: type === "Voluntario" ? "" : null
          };

          const { error } = await supabase.from("markers").insert(row);
          if (error) return alert("Error guardando marcador: " + error.message);

          await loadMarkers();
        });
      });
    }

    // ====== search buttons ======
    document.getElementById("searchVolunteerBtn").addEventListener("click", () => {
      const query = prompt("¬øQu√© voluntario quieres buscar? (nombre o parte del nombre)");
      if (!query) return;

      const q = query.trim().toLowerCase();
      const volunteers = markerLocations.filter(m =>
        m.type === "Voluntario" && (m.name || "").toLowerCase().includes(q)
      );

      if (volunteers.length === 0) return alert("No se encontr√≥ ning√∫n voluntario con ese nombre.");

      let chosen = volunteers[0];
      if (volunteers.length > 1) {
        const menu = volunteers.map((v, i) => `${i + 1}) ${v.name}`).join("\n");
        const choice = prompt(`He encontrado varios. Elige uno:\n\n${menu}\n\nEscribe el n√∫mero:`);
        const idx = Number(choice) - 1;
        if (Number.isNaN(idx) || idx < 0 || idx >= volunteers.length) return alert("Selecci√≥n no v√°lida.");
        chosen = volunteers[idx];
      }

      map.setView([chosen.lat, chosen.lng], 17, { animate: true });
      const marker = markersById.get(chosen.id);
      if (marker) marker.openPopup();
    });

    document.getElementById("searchFoodBtn").addEventListener("click", () => {
      const query = prompt("¬øQu√© punto de alimentaci√≥n quieres buscar? (nombre o parte del nombre)");
      if (!query) return;

      const q = query.trim().toLowerCase();
      const points = markerLocations.filter(m =>
        m.type === "Punto de alimentaci√≥n" && (m.name || "").toLowerCase().includes(q)
      );

      if (points.length === 0) return alert("No se encontr√≥ ning√∫n punto de alimentaci√≥n con ese nombre.");

      let chosen = points[0];
      if (points.length > 1) {
        const menu = points.map((p, i) => `${i + 1}) ${p.name}`).join("\n");
        const choice = prompt(`He encontrado varios puntos. Elige uno:\n\n${menu}\n\nEscribe el n√∫mero:`);
        const idx = Number(choice) - 1;
        if (Number.isNaN(idx) || idx < 0 || idx >= points.length) return alert("Selecci√≥n no v√°lida.");
        chosen = points[idx];
      }

      map.setView([chosen.lat, chosen.lng], 17, { animate: true });
      const marker = markersById.get(chosen.id);
      if (marker) marker.openPopup();
    });

    // ====== share button (DB) ======
    document.getElementById("shareBtn").addEventListener("click", async () => {
      const email = prompt("Correo de la persona con la que quieres compartir el mapa:");
      if (!email) return;
      const clean = email.trim().toLowerCase();
      if (!clean.includes("@")) return alert("Correo no v√°lido.");

      const { error } = await supabase.from("shares").insert({
        owner_id: currentUser.id,
        shared_email: clean
      });

      if (error) return alert("Error compartiendo: " + error.message);
      alert("Compartido con: " + clean);
    });

    // ====== logout right button ======
    document.getElementById("logoutBtn").addEventListener("click", async () => {
      await supabase.auth.signOut();
      window.location.replace("login.html");
    });

    // ====== init ======
    (async function init() {
      // 1) sesi√≥n o fuera
      currentUser = await requireLoginSupabase();
      if (!currentUser) return;

      // 2) header ok (NO navega, solo dropdown)
      setupHeader(currentUser);

      // 3) ya podemos mostrar la p√°gina
      document.body.setAttribute("data-ready", "1");

      // 4) mapa
      initMap();
      bindPopupDeleteHandlers();
      bindDblClickAddMarker();

      // 5) datos
      await loadMarkers();
    })();
  </script>

</body>
</html>