<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Proteccion Animal - Mapa</title>

  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="icon" type="image/x-icon" href="favicon.ico">

  <style>
    /* Evita que algo ‚Äúapriete‚Äù el mapa */
    .map-wrap {
      max-width: 1100px;
      margin: 0 auto;
      padding: 18px;
      width: 100%;
    }

    .map-card {
      overflow: hidden;
      border-radius: 18px;
    }

    /* ‚úÖ MAPA: grande en PC (como ‚Äúantes‚Äù) */
    #map {
      width: 100%;
      height: 78vh;
      min-height: 520px;
    }

    /* Tablet */
    @media (max-width: 1024px) {
      #map {
        height: 70vh;
        min-height: 460px;
      }
    }

    /* M√≥vil */
    @media (max-width: 640px) {
      #map {
        height: 60vh;
        min-height: 360px;
      }
    }

    /* ‚úÖ Fallback por si tu styles.css no incluye modal */
    .modal {
      position: fixed;
      inset: 0;
      display: none;
      z-index: 260000;
    }

    .modal.open {
      display: block;
    }

    .modal__backdrop {
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, 0.35);
      backdrop-filter: blur(4px);
    }

    .modal__card {
      position: relative;
      max-width: 560px;
      width: calc(100% - 24px);
      margin: 70px auto 24px;
      border-radius: 18px;
      background: rgba(255, 255, 255, 0.92);
      border: 1px solid rgba(17, 119, 204, 0.18);
      box-shadow: 0 24px 70px rgba(0, 0, 0, 0.18);
      overflow: hidden;
    }

    .modal__head {
      padding: 14px 16px;
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 10px;
      border-bottom: 1px solid rgba(17, 119, 204, 0.10);
      background: rgba(234, 246, 255, 0.65);
    }

    .modal__title {
      font-weight: 1000;
      font-size: 16px;
    }

    .modal__subtitle {
      font-weight: 800;
      font-size: 12px;
      color: #4a6173;
      margin-top: 2px;
    }

    .modal__close {
      cursor: pointer;
      border: none;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 12px;
      padding: 8px 10px;
      font-weight: 900;
    }

    .modal__body {
      padding: 14px 16px 16px;
    }

    /* mini overlay de carga (no rompe el fondo) */
    #loadingOverlay {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 999999;
      background: rgba(255,255,255,.25);
      backdrop-filter: blur(2px);
      font-weight: 1000;
      color: #1177cc;
    }
  </style>
</head>

<body>

  <header class="topbar">
    <div class="topbar__inner">
      <a class="brand" href="index.html">
        <span class="brand__dot"></span>
        <span class="brand__text">Proteccion Animal</span>
      </a>

      <nav class="nav">
        <a class="nav__link" href="index.html">Principal</a>
        <a class="nav__link nav__link--active" href="mapa.html">Mapa</a>
      </nav>

      <!-- ‚úÖ USER con dropdown -->
      <div class="user user--menu" id="userMenuWrap">
        <a class="user__btn" href="login.html" id="userBtn" aria-label="Cuenta">
          <span class="user__text" id="userLabel">Login</span>
        </a>

        <div class="user-dropdown" id="userDropdown" aria-label="Men√∫ usuario">
          <a class="user-dropdown__item" href="configurar.html" id="configUserBtn">‚öôÔ∏è Configurar usuario</a>
          <button class="user-dropdown__item user-dropdown__danger" type="button" id="logoutTopBtn">
            üö™ Cerrar sesi√≥n
          </button>
        </div>
      </div>
    </div>
  </header>

  <main class="map-wrap">
    <div class="map-card">
      <div class="map-header">
        <div class="map-header__left">
          <h2 class="map-title">Mapa - La Nuc√≠a</h2>
          <p class="map-subtitle">Doble click en el mapa para a√±adir voluntario o punto de alimentaci√≥n.</p>

          <!-- Botones arriba -->
          <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
            <button class="btn btn--primary" id="shareBtn" type="button">Compartir mapa</button>
            <button class="btn btn--ghost" id="searchVolunteerBtn" type="button">Voluntarios</button>
            <button class="btn btn--ghost" id="searchFoodBtn" type="button">Puntos</button>
          </div>
        </div>

        <div class="map-actions">
          <button class="btn btn--danger" id="logoutBtn" type="button">Cerrar sesi√≥n</button>
        </div>
      </div>

      <div id="map"></div>
    </div>
  </main>

  <!-- FOOTER -->
  <footer class="footer">
    <p>¬© <span id="year"></span> Extension de bello horizonte - PROTECCION ANIMAL</p>
  </footer>

  <!-- ‚úÖ input oculto para foto desde archivos -->
  <input id="photoInput" type="file" accept="image/*" style="display:none;" />

  <!-- ‚úÖ MODAL foto -->
  <div id="photoModal" class="modal" aria-hidden="true">
    <div class="modal__backdrop" id="photoModalBg"></div>

    <div class="modal__card" role="dialog" aria-modal="true" aria-label="A√±adir foto">
      <div class="modal__head">
        <div>
          <div class="modal__title">A√±adir foto</div>
          <div class="modal__subtitle">Opcional. Elige una imagen desde tu dispositivo.</div>
        </div>
        <button class="modal__close" id="photoModalClose" type="button">‚úñ</button>
      </div>

      <div class="modal__body">
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn btn--primary" id="pickPhotoBtn" type="button">üì∑ Elegir archivo</button>
          <button class="btn btn--ghost" id="skipPhotoBtn" type="button">Omitir</button>
        </div>

        <p class="note" style="margin-top:10px;">
          * Si cancelas el selector, se guardar√° sin foto.
        </p>
      </div>
    </div>
  </div>

  <div id="loadingOverlay">Cargando‚Ä¶</div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- ‚úÖ Supabase + l√≥gica (MODULE) -->
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    // =========================
    // ‚úÖ SUPABASE CONFIG (tus datos)
    // =========================
    const SUPABASE_URL = "https://vkyusosabullpvudxafy.supabase.co";
    const SUPABASE_KEY = "sb_publishable_8JbsqfmoH05omWj1p2jPXg_EwZDntlT";
    const BUCKET = "marker-photos"; // ‚úÖ tu bucket real
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    document.getElementById("year").textContent = new Date().getFullYear();

    const loading = document.getElementById("loadingOverlay");
    const showLoading = (t = "Cargando‚Ä¶") => { loading.textContent = t; loading.style.display = "flex"; };
    const hideLoading = () => { loading.style.display = "none"; };

    // =========================
    // ‚úÖ AUTH: requiere login (sin quedarse colgado)
    // =========================
    async function requireSessionOrRedirect() {
      showLoading("Cargando sesi√≥n‚Ä¶");
      const { data, error } = await supabase.auth.getSession();
      if (error) throw error;

      const session = data?.session;
      if (!session?.user) {
        window.location.replace("login.html");
        return null;
      }
      return session.user;
    }

    const user = await requireSessionOrRedirect();
    if (!user) throw new Error("No session");

    // =============================
    // ‚úÖ USER TOPBAR (dropdown) con Supabase
    // - click NO navega, solo abre men√∫
    // =============================
    (function () {
      const userLabel = document.getElementById("userLabel");
      const userBtn = document.getElementById("userBtn");
      const logoutTopBtn = document.getElementById("logoutTopBtn");
      const wrap = document.getElementById("userMenuWrap");

      const displayName =
        (user.user_metadata?.display_name && String(user.user_metadata.display_name).trim() !== "")
          ? String(user.user_metadata.display_name).trim()
          : (user.email || "Cuenta");

      userLabel.textContent = displayName;

      userBtn.href = "#";
      userBtn.addEventListener("click", (e) => {
        e.preventDefault();
        wrap.classList.toggle("open");
      });

      logoutTopBtn.addEventListener("click", async () => {
        await supabase.auth.signOut();
        window.location.replace("login.html");
      });

      document.addEventListener("click", (e) => {
        if (!wrap.contains(e.target)) wrap.classList.remove("open");
      });
    })();

    // =============================
    // MAPA (LA NUC√çA)
    // =============================
    const map = L.map('map').setView([38.6140, -0.1266], 14);

    const normal = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    });

    const satellite = L.tileLayer(
      'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
      { attribution: 'Tiles ¬© Esri' }
    );

    normal.addTo(map);
    L.control.layers({ "Mapa normal": normal, "Sat√©lite": satellite }).addTo(map);
    map.doubleClickZoom.disable();

    // ‚úÖ arreglo t√≠pico: cuando carga todo, fuerza tama√±o
    setTimeout(() => map.invalidateSize(), 250);

    // =============================
    // ICONOS
    // =============================
    function makePinIcon(color) {
      const svg = `
        <svg xmlns="http://www.w3.org/2000/svg" width="34" height="46" viewBox="0 0 24 24">
          <path fill="${color}" d="M12 2c-3.86 0-7 3.14-7 7 0 5.25 7 13 7 13s7-7.75 7-13c0-3.86-3.14-7-7-7z"/>
          <circle cx="12" cy="9" r="2.6" fill="#ffffff"/>
        </svg>
      `.trim();

      const url = "data:image/svg+xml;charset=UTF-8," + encodeURIComponent(svg);

      return L.icon({
        iconUrl: url,
        iconSize: [34, 46],
        iconAnchor: [17, 46],
        popupAnchor: [0, -40]
      });
    }

    const volunteerIcon = makePinIcon("#e53935");
    const foodIcon = makePinIcon("#1e8e3e");

    // =============================
    // helpers voluntario -> punto
    // =============================
    function fpIdFromLatLng(lat, lng) {
      const a = Number(lat).toFixed(6);
      const b = Number(lng).toFixed(6);
      return `fp:${a}:${b}`;
    }

    function getFoodPointNameByFpId(fpId) {
      if (!fpId) return "";
      const fp = markerLocations.find(m => m.type === "Punto de alimentaci√≥n" && m.fpId === fpId);
      return fp ? (fp.name || "Punto de alimentaci√≥n") : "";
    }

    // =============================
    // ‚úÖ FOTO desde archivos
    // =============================
    const photoInput = document.getElementById("photoInput");

    function pickImageFile(callback) {
      photoInput.value = "";
      const onChange = () => {
        const file = photoInput.files && photoInput.files[0];
        photoInput.removeEventListener("change", onChange);
        callback(file || null);
      };
      photoInput.addEventListener("change", onChange, { once: true });
      photoInput.click();
    }

    // =============================
    // ‚úÖ Modal de foto
    // =============================
    const photoModal = document.getElementById("photoModal");
    const photoModalBg = document.getElementById("photoModalBg");
    const photoModalClose = document.getElementById("photoModalClose");
    const pickPhotoBtn = document.getElementById("pickPhotoBtn");
    const skipPhotoBtn = document.getElementById("skipPhotoBtn");

    let __photoCb = null;

    function openPhotoModal(cb) {
      __photoCb = cb;
      photoModal.classList.add("open");
      photoModal.setAttribute("aria-hidden", "false");
    }

    function closePhotoModal() {
      photoModal.classList.remove("open");
      photoModal.setAttribute("aria-hidden", "true");
    }

    function finishPhotoModal(result) {
      const cb = __photoCb;
      __photoCb = null;
      closePhotoModal();
      if (cb) cb(result);
    }

    photoModalBg.addEventListener("click", () => finishPhotoModal(null));
    photoModalClose.addEventListener("click", () => finishPhotoModal(null));
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && photoModal.classList.contains("open")) finishPhotoModal(null);
    });
    skipPhotoBtn.addEventListener("click", () => finishPhotoModal(null));
    pickPhotoBtn.addEventListener("click", () => {
      pickImageFile((fileOrNull) => finishPhotoModal(fileOrNull || null));
    });

    // =============================
    // ‚úÖ DATOS (Supabase DB)
    // =============================
    let markerLocations = [];         // array para tu l√≥gica del mapa
    const markersByKey = new Map();   // key -> leaflet marker

    // si el bucket es public, publicUrl vale
    function getPublicUrl(photoPath) {
      if (!photoPath) return "";
      const { data } = supabase.storage.from(BUCKET).getPublicUrl(photoPath);
      return data?.publicUrl || "";
    }

    async function loadMarkersFromDb() {
      showLoading("Cargando marcadores‚Ä¶");

      const { data, error } = await supabase
        .from("markers")
        .select("*")
        .order("created_at", { ascending: true });

      if (error) {
        hideLoading();
        alert("Error cargando marcadores: " + error.message);
        return;
      }

      // limpiar markers leaflet
      markersByKey.clear();
      markerLocations = [];

      map.eachLayer(layer => {
        if (layer instanceof L.Marker) map.removeLayer(layer);
      });

      for (const row of (data || [])) {
        const obj = {
          id: row.id,
          lat: row.lat,
          lng: row.lng,
          type: row.type,
          name: row.name,
          description: row.description,
          fpId: row.fp_id || "",
          foodPointId: row.food_point_id || "",
          photoPath: row.photo_path || "",
          photoUrl: row.photo_path ? getPublicUrl(row.photo_path) : ""
        };
        markerLocations.push(obj);
        createMarker(obj);
      }

      hideLoading();
      setTimeout(() => map.invalidateSize(), 200);
    }

    await loadMarkersFromDb();

    // =============================
    // DOBLE CLICK -> A√ëADIR (Supabase)
    // =============================
    map.on('dblclick', async function (e) {
      const { lat, lng } = e.latlng;

      const option = prompt(
        "¬øQu√© quieres a√±adir?\n\n" +
        "1) Voluntario üî¥\n" +
        "2) Punto de alimentaci√≥n üü¢\n\n" +
        "Escribe 1 o 2:"
      );

      let type = null;
      if (option === "1") type = "Voluntario";
      if (option === "2") type = "Punto de alimentaci√≥n";
      if (!type) return;

      const name = prompt("Nombre:");
      const description = prompt("Descripci√≥n:");
      if (!name || !description) return;

      openPhotoModal(async (fileOrNull) => {
        try {
          showLoading("Guardando marcador‚Ä¶");

          let photoPath = null;

          // subir foto si existe
          if (fileOrNull) {
            const ext = (fileOrNull.name.split(".").pop() || "jpg").toLowerCase().replace(/[^a-z0-9]/g, "") || "jpg";
            const path = `${user.id}/${crypto.randomUUID()}.${ext}`;

            const { error: upErr } = await supabase
              .storage
              .from(BUCKET)
              .upload(path, fileOrNull, { upsert: false });

            if (upErr) {
              alert("No se pudo subir la foto: " + upErr.message);
            } else {
              photoPath = path;
            }
          }

          const insertObj = {
            user_id: user.id,
            lat,
            lng,
            type,
            name,
            description,
            photo_path: photoPath,
            fp_id: (type === "Punto de alimentaci√≥n") ? fpIdFromLatLng(lat, lng) : null,
            food_point_id: (type === "Voluntario") ? "" : null
          };

          const { data: inserted, error: insErr } = await supabase
            .from("markers")
            .insert(insertObj)
            .select("*")
            .single();

          if (insErr) {
            // si insert falla y subi√≥ foto, intenta borrar foto
            if (photoPath) await supabase.storage.from(BUCKET).remove([photoPath]);
            hideLoading();
            alert("Error guardando marcador: " + insErr.message);
            return;
          }

          const obj = {
            id: inserted.id,
            lat: inserted.lat,
            lng: inserted.lng,
            type: inserted.type,
            name: inserted.name,
            description: inserted.description,
            fpId: inserted.fp_id || "",
            foodPointId: inserted.food_point_id || "",
            photoPath: inserted.photo_path || "",
            photoUrl: inserted.photo_path ? getPublicUrl(inserted.photo_path) : ""
          };

          markerLocations.push(obj);
          createMarker(obj);

          hideLoading();

        } catch (err) {
          console.error(err);
          hideLoading();
          alert("Error inesperado al a√±adir marcador.");
        }
      });
    });

    // =============================
    // CREAR MARCADOR + BORRAR (Supabase)
    // =============================
    function createMarker(m) {
      const icon = (m.type === "Punto de alimentaci√≥n") ? foodIcon : volunteerIcon;

      let belongsHtml = "";
      if (m.type === "Voluntario") {
        const fpName = getFoodPointNameByFpId(m.foodPointId);
        if (fpName) {
          belongsHtml = `
            <div style="margin-top:8px; padding:8px; border-radius:12px; background: rgba(30,142,62,0.10); border: 1px solid rgba(30,142,62,0.22);">
              <b>üü¢ Pertenece a:</b> ${escapeHtml(fpName)}
            </div>
          `;
        } else {
          belongsHtml = `
            <div class="note" style="margin-top:8px;">
              (No asignado a ning√∫n punto de alimentaci√≥n)
            </div>
          `;
        }
      }

      const typeColor = (m.type === "Punto de alimentaci√≥n") ? "#1e8e3e" : "#e53935";

      const marker = L.marker([m.lat, m.lng], { icon }).addTo(map)
        .bindPopup(`
          <b>${escapeHtml(m.name)}</b><br>
          <span style="font-weight:900;color:${typeColor};">
            ${escapeHtml(m.type)}
          </span><br>
          ${escapeHtml(m.description)}<br>
          ${m.photoUrl ? `<img src="${escapeAttr(m.photoUrl)}" style="width:100px;height:100px;object-fit:cover;border-radius:10px;margin-top:8px;">` : ""}
          ${belongsHtml}
          <div style="margin-top:10px;">
            <button type="button" class="popup-btn danger"
              data-action="delete"
              data-id="${m.id}">
              Eliminar
            </button>
          </div>
        `)
        .bindTooltip(m.name, { direction: 'top' });

      const key = buildKey(m.type, m.name, m.lat, m.lng);
      markersByKey.set(key, marker);
    }

    map.on("popupopen", function (e) {
      const root = e.popup.getElement();
      if (!root) return;

      root.querySelectorAll("button[data-action='delete']").forEach(btn => {
        if (btn.dataset.bound === "1") return;
        btn.dataset.bound = "1";

        btn.addEventListener("click", async (ev) => {
          ev.preventDefault();
          ev.stopPropagation();

          const id = btn.dataset.id;
          const ok = confirm("¬øSeguro que quieres eliminar este marcador?");
          if (!ok) return;

          await deleteMarkerById(id);
          map.closePopup();
        });
      });
    });

    async function deleteMarkerById(id) {
      const m = markerLocations.find(x => String(x.id) === String(id));
      if (!m) return;

      try {
        showLoading("Borrando‚Ä¶");

        const { error } = await supabase.from("markers").delete().eq("id", id);
        if (error) {
          hideLoading();
          alert("Error borrando marcador: " + error.message);
          return;
        }

        if (m.photoPath) {
          await supabase.storage.from(BUCKET).remove([m.photoPath]);
        }

        markerLocations = markerLocations.filter(x => String(x.id) !== String(id));

        // repintar (mantengo tu forma simple, sin romper nada)
        markersByKey.clear();
        map.eachLayer(layer => {
          if (layer instanceof L.Marker) map.removeLayer(layer);
        });
        markerLocations.forEach(createMarker);

        hideLoading();

      } catch (err) {
        console.error(err);
        hideLoading();
        alert("Error inesperado borrando.");
      }
    }

    // =============================
    // BUSCAR VOLUNTARIO
    // =============================
    document.getElementById("searchVolunteerBtn").addEventListener("click", () => {
      const query = prompt("¬øQu√© voluntario quieres buscar? (escribe nombre o parte del nombre)");
      if (!query) return;

      const q = query.trim().toLowerCase();
      const volunteers = markerLocations.filter(m =>
        m.type === "Voluntario" && (m.name || "").toLowerCase().includes(q)
      );

      if (volunteers.length === 0) {
        alert("No se encontr√≥ ning√∫n voluntario con ese nombre.");
        return;
      }

      if (volunteers.length === 1) {
        focusMarker(volunteers[0]);
        return;
      }

      const menu = volunteers.map((v, i) => `${i + 1}) ${v.name}`).join("\n");
      const choice = prompt(`He encontrado varios. Elige uno:\n\n${menu}\n\nEscribe el n√∫mero:`);

      const idx = Number(choice) - 1;
      if (Number.isNaN(idx) || idx < 0 || idx >= volunteers.length) {
        alert("Selecci√≥n no v√°lida.");
        return;
      }

      focusMarker(volunteers[idx]);
    });

    // =============================
    // BUSCAR PUNTO DE ALIMENTACI√ìN
    // =============================
    document.getElementById("searchFoodBtn").addEventListener("click", () => {
      const query = prompt("¬øQu√© punto de alimentaci√≥n quieres buscar? (nombre o parte del nombre)");
      if (!query) return;

      const q = query.trim().toLowerCase();
      const points = markerLocations.filter(m =>
        m.type === "Punto de alimentaci√≥n" && (m.name || "").toLowerCase().includes(q)
      );

      if (points.length === 0) {
        alert("No se encontr√≥ ning√∫n punto de alimentaci√≥n con ese nombre.");
        return;
      }

      if (points.length === 1) {
        focusMarker(points[0]);
        return;
      }

      const menu = points.map((p, i) => `${i + 1}) ${p.name}`).join("\n");
      const choice = prompt(`He encontrado varios puntos. Elige uno:\n\n${menu}\n\nEscribe el n√∫mero:`);

      const idx = Number(choice) - 1;
      if (Number.isNaN(idx) || idx < 0 || idx >= points.length) {
        alert("Selecci√≥n no v√°lida.");
        return;
      }

      focusMarker(points[idx]);
    });

    function focusMarker(m) {
      const key = buildKey(m.type, m.name, m.lat, m.lng);
      const marker = markersByKey.get(key);

      map.setView([m.lat, m.lng], 17, { animate: true });
      if (marker) marker.openPopup();
    }

    function buildKey(type, name, lat, lng) {
      return `${type}:${String(name).toLowerCase()}:${lat}:${lng}`;
    }

    // =============================
    // COMPARTIR (DB) -> tabla shares
    // =============================
    document.getElementById("shareBtn").addEventListener("click", async () => {
      const email = prompt("Correo de la persona con la que quieres compartir el mapa:");
      if (!email) return;

      const clean = email.trim().toLowerCase();
      if (!clean.includes("@")) {
        alert("Correo no v√°lido.");
        return;
      }

      try {
        showLoading("Compartiendo‚Ä¶");

        const { error } = await supabase.from("shares").insert({
          owner_id: user.id,
          shared_email: clean
        });

        hideLoading();

        if (error) {
          alert("Error compartiendo: " + error.message);
          return;
        }

        alert("Compartido con: " + clean);
      } catch (err) {
        console.error(err);
        hideLoading();
        alert("Error inesperado compartiendo.");
      }
    });

    // =============================
    // LOGOUT
    // =============================
    document.getElementById("logoutBtn").addEventListener("click", async () => {
      await supabase.auth.signOut();
      window.location.replace("login.html");
    });

    // Utils escape
    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, (m) => ({
        "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#039;"
      }[m]));
    }
    function escapeAttr(str) {
      return escapeHtml(str).replace(/`/g, "&#096;");
    }

    hideLoading();
  </script>

</body>
</html>