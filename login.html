<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Proteccion Animal - Login</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="icon" type="image/x-icon" href="favicon.ico">
</head>

<body>

  <header class="topbar">
    <div class="topbar__inner">
      <a class="brand" href="index.html">
        <span class="brand__dot"></span>
        <span class="brand__text">Proteccion Animal</span>
      </a>

      <nav class="nav">
        <a class="nav__link" href="index.html">Principal</a>
        <a class="nav__link" href="mapa.html">Mapa</a>
      </nav>

      <div class="user">
        <a class="user__btn" href="login.html" id="userBtn">
          <span class="user__text" id="userText">Login</span>
        </a>
      </div>
    </div>
  </header>

  <main class="auth-wrap">
    <div class="auth-card">
      <h1 class="auth-title">Inicia sesión</h1>
      <p class="auth-subtitle">Con Supabase. Si no tienes cuenta, crea una.</p>

      <div class="form">
        <input class="input" id="email" type="email" placeholder="Email" autocomplete="email" />
        <input class="input" id="password" type="password" placeholder="Contraseña" autocomplete="current-password" />

        <div class="form-row">
          <button class="btn btn--primary" id="loginBtn" type="button">Entrar</button>
          <button class="btn btn--ghost" id="signupBtn" type="button">Crear cuenta</button>
        </div>

        <p class="note" id="msg"></p>
      </div>
    </div>
  </main>

  <footer class="footer">
    <p>© <span id="year"></span> Extension de bello horizonte - PROTECCION ANIMAL</p>
  </footer>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase-client.js"></script>

  <script>
    document.getElementById("year").textContent = new Date().getFullYear();

    const emailEl = document.getElementById("email");
    const passEl = document.getElementById("password");
    const msgEl = document.getElementById("msg");

    function setMsg(text, isError = false) {
      msgEl.textContent = text;
      msgEl.style.color = isError ? "#7a1b3b" : "#1177cc";
      msgEl.style.fontWeight = "900";
    }

    // Header dinámico (display_name > email)
    async function applyUserHeader() {
      const { data } = await supabase.auth.getUser();
      const user = data?.user;

      const userText = document.getElementById("userText");
      const userBtn = document.getElementById("userBtn");
      if (!userText || !userBtn) return;

      if (!user) {
        userText.textContent = "Login";
        userBtn.href = "login.html";
        return;
      }

      const displayName = (user.user_metadata?.display_name || "").trim();
      userText.textContent = displayName || user.email || "Cuenta";
      userBtn.href = "mapa.html";
    }

    // Si ya hay sesión -> mapa
    (async function () {
      const { data } = await supabase.auth.getSession();
      if (data?.session) {
        window.location.href = "mapa.html";
        return;
      }
      await applyUserHeader();
    })();

    // Crear cuenta
    document.getElementById("signupBtn").addEventListener("click", () => {
      window.location.href = "crear-cuenta.html";
    });

    // Login
    document.getElementById("loginBtn").addEventListener("click", async () => {
      const email = (emailEl.value || "").trim().toLowerCase();
      const password = passEl.value || "";

      if (!email.includes("@")) return setMsg("Email no válido.", true);
      if (password.length < 6) return setMsg("Contraseña muy corta (mínimo 6).", true);

      setMsg("Entrando...");

      const { error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) return setMsg("Error: " + error.message, true);

      window.location.href = "mapa.html";
    });
  </script>

</body>
</html>